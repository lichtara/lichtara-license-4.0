name: Build & Release Lichtara License v4.0 + Zenodo Upload

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build-pdf:
        name: Build PDF
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Install LaTeX
              run: |
                  sudo apt-get update
                  sudo apt-get install -y texlive-xetex \
                    texlive-fonts-recommended \
                    texlive-latex-extra

            - name: Build PDF
              working-directory: ./pdf
              run: |
                  chmod +x build.sh
                  ./build.sh

            - name: Upload PDF artifact
              uses: actions/upload-artifact@v4
              with:
                  name: Lichtara-License-v4.0-PDF
                  path: pdf/LICENSE-v4.0.pdf

    publish-zenodo:
        name: Publish to Zenodo
        needs: build-pdf
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Download built PDF
              uses: actions/download-artifact@v4
              with:
                  name: Lichtara-License-v4.0-PDF
                  path: pdf/

            - name: Prepare metadata
              run: |
                  echo "Usando metadata.json"
                  cp zenodo/metadata.json .

            - name: Determine Zenodo Endpoint
              id: endpoint
              run: |
                  if [ "${{ secrets.ZENODO_SANDBOX }}" = "true" ]; then
                    echo "url=https://sandbox.zenodo.org/api/deposit/depositions" >> $GITHUB_OUTPUT
                  else
                    echo "url=https://zenodo.org/api/deposit/depositions" >> $GITHUB_OUTPUT
                  fi

            - name: Upload to Zenodo
              env:
                  ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
              run: |
                  curl \
                    -H "Authorization: Bearer $ZENODO_TOKEN" \
                    -F "metadata=@metadata.json" \
                    -F "file=@pdf/LICENSE-v4.0.pdf" \
                    ${{ steps.endpoint.outputs.url }}

            - name: Mark Release on GitHub
              uses: softprops/action-gh-release@v2
              with:
                  files: pdf/LICENSE-v4.0.pdf
