name: Lichtara License — Build + Release Pipeline

on:
    push:
        branches:
            - main
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            # -----------------------
            # VALIDAR INCLUDES
            # -----------------------
            - name: Validate includes in master.md
              run: |
                  echo "Validando caminhos de include..."
                  FILE=pdf/master.md
                  grep -oP '(?<=include\{)..*?(?=\})' $FILE | while read -r inc
                  do
                    path=$(echo "$inc")
                    full="pdf/$path"
                    if [ ! -f "$full" ]; then
                      echo "❌ Include ausente: $full"
                      exit 1
                    else
                      echo "✔ Include OK: $full"
                    fi
                  done

            # -----------------------
            # INSTALAR LATEX
            # -----------------------
            - name: Install LaTeX (minimal)
              run: |
                  sudo apt-get update
                  sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-latex-extra

            # -----------------------
            # BUILD DO PDF
            # -----------------------
            - name: Build PDF
              working-directory: ./pdf
              run: |
                  chmod +x build.sh
                  ./build.sh

            # -----------------------
            # GERAR SHA256
            # -----------------------
            - name: Generate SHA256
              run: |
                  sha256sum pdf/LICENSE-v4.0.pdf > pdf/LICENSE-v4.0.sha256

            # -----------------------
            # ATUALIZAR ARTIFACT
            # -----------------------
            - name: Upload PDF and SHA artifact
              uses: actions/upload-artifact@v4
              with:
                  name: Lichtara-License-v4.0-Package
                  path: |
                      pdf/LICENSE-v4.0.pdf
                      pdf/LICENSE-v4.0.sha256

            # -----------------------
            # CRIAR RELEASE AUTOMATICAMENTE
            # -----------------------
            - name: Generate Release Notes
              if: startsWith(github.ref, 'refs/tags/v')
              id: notes
              run: |
                  echo "Gerando release notes a partir do CHANGELOG..."
                  last_section=$(awk '/^## /{print NR}' pdf/CHANGELOG-PDF.md | tail -n 1)
                  tail -n +$last_section pdf/CHANGELOG-PDF.md > release-notes.md
                  echo "release_notes<<EOF" >> $GITHUB_OUTPUT
                  cat release-notes.md >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Upload to GitHub Release
              if: startsWith(github.ref, 'refs/tags/v')
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      pdf/LICENSE-v4.0.pdf
                      pdf/LICENSE-v4.0.sha256
                  body: ${{ steps.notes.outputs.release_notes }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # -----------------------
    # BADGE (STATUS)
    # -----------------------
    badge:
        runs-on: ubuntu-latest
        steps:
            - name: Generate badge SVG
              run: |
                  mkdir -p badges
                  echo '<svg xmlns="http://www.w3.org/2000/svg" width="170" height="30">
                    <rect width="170" height="30" fill="#0A1A2F"/>
                    <text x="10" y="20" fill="#D4AF37" font-size="14">
                      License v4.0 — Build OK
                    </text></svg>' > badges/build-status.svg

            - name: Upload badge artifact
              uses: actions/upload-artifact@v4
              with:
                  name: build-status-badge
                  path: badges/build-status.svg
